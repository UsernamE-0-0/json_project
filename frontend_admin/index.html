<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

        <div class="form-container">
            <h2>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
            <form id="productForm">
                <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="name" required>
                
                <label for="price">–¶–µ–Ω–∞:</label>
                <input type="number" id="price" step="0.01" required>
                
                <label for="desc">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="desc"></textarea>
                
                <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                <input type="text" id="category">
                
                <button type="button" onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
            </form>
        </div>

        <div class="products-list">
            <h2>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h2>
            <div class="product-filters">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." oninput="filterProducts()">
            </div>
            <ul id="adminProductList"></ul>
        </div>

        <div class="chat-box">
            <h3>–ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h3>
            <div id="adminChat" class="chat-messages"></div>
            <div class="chat-input">
                <textarea 
                    id="adminChatInput" 
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É..." 
                    rows="3"
                    class="chat-textarea"
                ></textarea>
                <button onclick="sendAdminMessage()" class="chat-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // WebSocket —á–∞—Ç 
        const ws = new WebSocket('ws://localhost:3000');
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
        function displayChatMessage(sender, text, timestamp) {
            const chat = document.getElementById('adminChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `
                <span class="sender">${sender === 'admin' ? '–í—ã' : '–ö–ª–∏–µ–Ω—Ç'}:</span>
                <span class="text">${text}</span>
                <span class="time">${new Date(timestamp).toLocaleTimeString()}</span>
            `;
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.sender === 'user') {
                displayChatMessage('user', msg.text, msg.timestamp);
            }
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendAdminMessage() {
            const input = document.getElementById('adminChatInput');
            const text = input.value.trim();
            
            if (text && ws.readyState === WebSocket.OPEN) {
                const msg = {
                    sender: 'admin',
                    text: text,
                    timestamp: new Date().toISOString()
                };
                
                ws.send(JSON.stringify(msg));
                displayChatMessage('admin', text, msg.timestamp);
                input.value = '';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter (Shift+Enter - –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏)
        document.getElementById('adminChatInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAdminMessage();
            }
        });

        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const products = await response.json();
                renderProducts(products);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
        function renderProducts(products) {
            const list = document.getElementById('adminProductList');
            list.innerHTML = products.map(product => `
                <li data-id="${product.id}">
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <span>${product.price} —Ä—É–±.</span>
                        ${product.description ? `<p>${product.description}</p>` : ''}
                        ${product.category ? `<small>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${product.category}</small>` : ''}
                    </div>
                    <div class="product-actions">
                        <button onclick="editProduct(${product.id})" class="edit-btn">‚úèÔ∏è</button>
                        <button onclick="deleteProduct(${product.id})" class="delete-btn">üóëÔ∏è</button>
                    </div>
                </li>
            `).join('');
        }
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤
        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const items = document.querySelectorAll('#adminProductList li');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        async function addProduct() {
            const newProduct = {
                name: document.getElementById('name').value,
                price: parseFloat(document.getElementById('price').value),
                description: document.getElementById('desc').value,
                category: document.getElementById('category').value,
                id: Date.now()
            };
            
            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newProduct)
                });
                
                if (response.ok) {
                    loadProducts();
                    document.getElementById('productForm').reset();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', error);
            }
        }
        
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        async function editProduct(id) {
            const products = await (await fetch('/api/products')).json();
            const product = products.find(p => p.id === id);
        
            if (product) {
              // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞
              document.getElementById('name').value = product.name;
              document.getElementById('price').value = product.price;
              document.getElementById('desc').value = product.description || '';
              document.getElementById('category').value = product.category || '';
          
              // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å" –Ω–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
              const submitBtn = document.querySelector('#productForm button');
              submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
              submitBtn.onclick = () => updateProduct(id); // –¢–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å updateProduct
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
        async function updateProduct(id) {
            const updatedProduct = {
                name: document.getElementById('name').value,
                price: parseFloat(document.getElementById('price').value),
                description: document.getElementById('desc').value,
                category: document.getElementById('category').value,
            };
        
            try {
            const response = await fetch(`/api/products/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedProduct),
            });
        
            if (response.ok) {
                loadProducts();
                document.getElementById('productForm').reset();
                const submitBtn = document.querySelector('#productForm button');
                submitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
                submitBtn.onclick = addProduct; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
            }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', error);
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        async function deleteProduct(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) return;         
            try {
                const response = await fetch(`/api/products/${id}`, {
                    method: 'DELETE',
            });       
                if (response.ok) {
                    loadProducts(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', await response.json());
                }
                } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', error);
                }
            }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 
        window.onload = () => {
            loadProducts();
            document.getElementById('adminChatInput').focus();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è WebSocket
            ws.onopen = () => console.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            ws.onerror = (error) => console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
        };
    </script>
</body>
</html>